"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[7766],{"./src/components/views/location/LocationButton.tsx":(e,t,o)=>{o.r(t),o.d(t,{default:()=>re});var n=o("./node_modules/react/index.js"),s=o("./node_modules/classnames/index.js"),a=o.n(s),i=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/location-pin-solid.js"),r=o("./src/languageHandler.tsx"),l=o("./src/components/views/rooms/CollapsibleButton.tsx"),c=o("./src/components/structures/ContextMenu.tsx"),m=o("./src/components/views/rooms/MessageComposerButtons.tsx"),d=o("./node_modules/@babel/runtime/helpers/esm/extends.js"),u=o("./src/contexts/MatrixClientContext.tsx"),p=o("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),h=o("./node_modules/maplibre-gl/dist/maplibre-gl.js"),_=o.n(h),v=o("./node_modules/matrix-js-sdk/src/logger.ts"),g=o("./node_modules/matrix-js-sdk/src/matrix.ts"),b=o("./src/Modal.tsx"),k=o("./src/utils/WellKnownUtils.ts"),y=o("./src/utils/beacon/index.ts"),x=o("./src/utils/location/index.ts"),E=o("./src/components/views/dialogs/ErrorDialog.tsx"),C=o("./src/components/views/elements/AccessibleButton.tsx"),S=o("./src/components/views/location/MapError.tsx"),A=o("./src/DateUtils.ts"),L=o("./src/components/views/elements/Dropdown.tsx");const w={fifteenMins:9e5,oneHour:36e5,eightHours:288e5},f=w.fifteenMins,M=e=>(0,r._t)("location_sharing|live_share_button",{duration:(0,A.a3)(e)}),N=({timeout:e,onChange:t})=>{const o=Object.values(w).map(e=>({key:e.toString(),duration:e,label:M(e)}));Object.values(w).includes(e)||o.push({key:e.toString(),duration:e,label:M(e)});return n.createElement(L.A,{id:"live-duration",label:M(e),value:e.toString(),onOptionChange:e=>{t(+e)},className:"mx_LiveDurationDropdown"},o.map(({key:e,label:t})=>n.createElement("div",{key:e},t)))};var T=o("./src/components/views/dialogs/QuestionDialog.tsx"),P=o("./src/SdkConfig.ts"),B=o("./src/stores/OwnBeaconStore.ts"),F=o("./src/utils/local-room.ts");let j=function(e){return e.Own="Own",e.Pin="Pin",e.Live="Live",e}({});const D=(e,t,o)=>{const{modalParams:n,errorMessage:s}="M_FORBIDDEN"===e.errcode?(e=>{const t=e===j.Live?"Insufficient permissions to start sharing your live location":"Insufficient permissions to send your location";return{modalParams:{title:(0,r._t)("location_sharing|error_no_perms_title"),description:(0,r._t)("location_sharing|error_no_perms_description"),button:(0,r._t)("action|ok"),hasCancelButton:!1,onFinished:()=>{}},errorMessage:t}})(o):((e,t)=>{const o=e===j.Live?"We couldn't start sharing your live location":"We couldn't send your location";return{modalParams:{title:(0,r._t)("location_sharing|error_send_title"),description:(0,r._t)("location_sharing|error_send_description",{brand:P.Ay.get().brand}),button:(0,r._t)("action|try_again"),cancelButton:(0,r._t)("action|cancel"),onFinished:e=>{e&&t()}},errorMessage:o}})(o,t);v.vF.error(s,e),b.Ay.createDialog(T.A,n)};var O=o("./src/components/views/location/Marker.tsx");const I=e=>e===j.Own||e===j.Live;class U extends n.Component{constructor(e){super(e),(0,p.A)(this,"map",void 0),(0,p.A)(this,"geolocate",void 0),(0,p.A)(this,"marker",void 0),(0,p.A)(this,"getMarkerId",()=>"mx_MLocationPicker_marker"),(0,p.A)(this,"addMarkerToMap",()=>{var e;this.marker=new(_().Marker)({element:null!==(e=document.getElementById(this.getMarkerId()))&&void 0!==e?e:void 0,anchor:"bottom",offset:[0,-1]}).setLngLat(new(_().LngLat)(0,0)).addTo(this.map)}),(0,p.A)(this,"updateStyleUrl",e=>{var t;const o=null===(t=(0,k.XP)(e))||void 0===t?void 0:t.map_style_url;var n;o&&(null===(n=this.map)||void 0===n||n.setStyle(o))}),(0,p.A)(this,"onGeolocate",e=>{var t;this.marker||this.addMarkerToMap(),this.setState({position:(0,y.v9)(e)}),null===(t=this.marker)||void 0===t||t.setLngLat(new(_().LngLat)(e.coords.longitude,e.coords.latitude))}),(0,p.A)(this,"onClick",e=>{var t;this.marker||this.addMarkerToMap(),null===(t=this.marker)||void 0===t||t.setLngLat(e.lngLat),this.setState({position:{timestamp:Date.now(),latitude:e.lngLat.lat,longitude:e.lngLat.lng}})}),(0,p.A)(this,"onGeolocateError",e=>{var t;(v.vF.error("Could not fetch location",e),I(this.props.shareType)&&(this.props.onFinished(),b.Ay.createDialog(E.A,{title:(0,r._t)("location_sharing|error_fetch_location"),description:(0,x.Ff)(e.code)})),this.geolocate)&&(null===(t=this.map)||void 0===t||t.removeControl(this.geolocate))}),(0,p.A)(this,"onTimeoutChange",e=>{this.setState({timeout:e})}),(0,p.A)(this,"onOk",()=>{const{timeout:e,position:t}=this.state;this.props.onChoose(t?{uri:(0,y.mt)(t),timestamp:t.timestamp,timeout:e}:{timeout:e}),this.props.onFinished()}),this.state={position:void 0,timeout:f,error:void 0}}componentDidMount(){this.context.on(g.ClientEvent.ClientWellKnown,this.updateStyleUrl);try{if(this.map=new(_().Map)({container:"mx_LocationPicker_map",style:(0,x.M0)(this.context),center:[0,0],zoom:1}),this.geolocate=new(_().GeolocateControl)({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!1}),this.map.addControl(this.geolocate),this.map.on("error",e=>{v.vF.error("Failed to load map: check map_style_url in config.json has a valid URL and API key",e.error),this.setState({error:x.$X.MapStyleUrlNotReachable})}),this.map.on("load",()=>{var e;null===(e=this.geolocate)||void 0===e||e.trigger()}),this.geolocate.on("error",this.onGeolocateError),I(this.props.shareType)&&this.geolocate.on("geolocate",this.onGeolocate),this.props.shareType===j.Pin){const e=new(_().NavigationControl)({showCompass:!1,showZoom:!0});this.map.addControl(e,"bottom-right"),this.map.on("click",this.onClick)}}catch(e){v.vF.error("Failed to render map",e);const t=null==e?void 0:e.message;let o;o=t===x.$X.MapStyleUrlNotConfigured?x.$X.MapStyleUrlNotConfigured:t.includes("Failed to initialize WebGL")?x.$X.WebGLNotEnabled:x.$X.Default,this.setState({error:o})}}componentWillUnmount(){var e,t,o;null===(e=this.geolocate)||void 0===e||e.off("error",this.onGeolocateError),null===(t=this.geolocate)||void 0===t||t.off("geolocate",this.onGeolocate),null===(o=this.map)||void 0===o||o.off("click",this.onClick),this.context.off(g.ClientEvent.ClientWellKnown,this.updateStyleUrl)}render(){return this.state.error?n.createElement("div",{className:"mx_LocationPicker mx_LocationPicker_hasError"},n.createElement(S.p,{error:this.state.error,onFinished:this.props.onFinished})):n.createElement("div",{className:"mx_LocationPicker"},n.createElement("div",{id:"mx_LocationPicker_map"}),this.props.shareType===j.Pin&&n.createElement("div",{className:"mx_LocationPicker_pinText"},n.createElement("span",null,this.state.position?(0,r._t)("location_sharing|click_move_pin"):(0,r._t)("location_sharing|click_drop_pin"))),n.createElement("div",{className:"mx_LocationPicker_footer"},n.createElement("form",{onSubmit:this.onOk},this.props.shareType===j.Live&&n.createElement(N,{onChange:this.onTimeoutChange,timeout:this.state.timeout}),n.createElement(C.A,{type:"submit",element:"button",kind:"primary",className:"mx_LocationPicker_submitButton",disabled:!this.state.position,onClick:this.onOk},(0,r._t)("location_sharing|share_button")))),n.createElement("div",{id:this.getMarkerId()},!!this.marker&&n.createElement(O.A,{roomMember:I(this.props.shareType)?this.props.sender:void 0,useMemberColor:this.props.shareType===j.Live})))}}(0,p.A)(U,"contextType",u.Ay);const G=U;var H=o("./src/settings/SettingsStore.ts"),W=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/close.js"),$=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/chevron-left.js");const R=({onBack:e,onCancel:t,displayBack:o})=>n.createElement("div",{className:"mx_ShareDialogButtons"},o&&n.createElement(C.A,{className:"mx_ShareDialogButtons_button left","aria-label":(0,r._t)("action|back"),onClick:e,element:"button"},n.createElement($.A,{className:"mx_ShareDialogButtons_button-icon"})),n.createElement(C.A,{className:"mx_ShareDialogButtons_button right","aria-label":(0,r._t)("action|close"),onClick:t,element:"button"},n.createElement(W.A,{className:"mx_ShareDialogButtons_button-icon"})));var z=o("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),X=o("./src/stores/OwnProfileStore.ts"),V=o("./src/components/views/avatars/BaseAvatar.tsx"),K=o("./src/components/views/typography/Heading.tsx"),J=o("./src/components/views/beacon/StyledLiveBeaconIcon.tsx");const Y=["onClick","label","shareType"],Z=()=>{var e,t;const o=(0,n.useContext)(u.Ay).getSafeUserId(),s=null!==(e=X.V.instance.displayName)&&void 0!==e?e:void 0,a="36px",i=null!==(t=X.V.instance.getHttpAvatarUrl(parseInt(a,10)))&&void 0!==t?t:void 0;return n.createElement("div",{className:`mx_ShareType_option-icon ${j.Own}`},n.createElement(V.A,{idName:o,name:s,url:i,size:a,className:"mx_UserMenu_userAvatar_BaseAvatar"}))},q=e=>{let{onClick:t,label:o,shareType:s}=e,a=(0,z.A)(e,Y);return n.createElement(C.A,(0,d.A)({element:"button",className:"mx_ShareType_option",onClick:null!=t?t:null},a),s===j.Own&&n.createElement(Z,null),s===j.Pin&&n.createElement(i.A,{className:`mx_ShareType_option-icon ${j.Pin}`}),s===j.Live&&n.createElement(J.A,{className:`mx_ShareType_option-icon ${j.Live}`}),o)},Q=({setShareType:e,enabledShareTypes:t})=>{const o={[j.Own]:(0,r._t)("location_sharing|share_type_own"),[j.Live]:(0,r._t)("location_sharing|share_type_live"),[j.Pin]:(0,r._t)("location_sharing|share_type_pin")};return n.createElement("div",{className:"mx_ShareType"},n.createElement(i.A,{className:"mx_ShareType_badge"}),n.createElement(K.A,{className:"mx_ShareType_heading",size:"3"},(0,r._t)("location_sharing|share_type_prompt")),n.createElement("div",{className:"mx_ShareType_wrapper_options"},t.map(t=>n.createElement(q,{key:t,onClick:()=>e(t),label:o[t],shareType:t}))))};var ee=o("./node_modules/@vector-im/compound-web/dist/components/Form/Root.js"),te=o("./node_modules/@vector-im/compound-web/dist/components/Form/Controls/SettingsToggle/SettingsToggle.js"),oe=o("./node_modules/@vector-im/compound-web/dist/components/Button/Button.js");const ne=({onSubmit:e})=>{const[t,o]=(0,n.useState)(!1),s=(0,n.useCallback)(e=>o(e.target.checked),[o]),a=(0,n.useCallback)(o=>{o.preventDefault(),o.stopPropagation(),t&&e()},[t,e]);return n.createElement("div",{className:"mx_EnableLiveShare"},n.createElement(J.A,{className:"mx_EnableLiveShare_icon"}),n.createElement(K.A,{className:"mx_EnableLiveShare_heading",size:"3"},(0,r._t)("location_sharing|live_enable_heading")),n.createElement("p",{className:"mx_EnableLiveShare_description"},(0,r._t)("location_sharing|live_enable_description")),n.createElement(ee.b,{onSubmit:a},n.createElement(te.I,{name:"enable-live-share-toggle",checked:t,onChange:s,label:(0,r._t)("location_sharing|live_toggle_label")}),n.createElement(oe.$,{className:"mx_EnableLiveShare_button",kind:"primary",disabled:!t},(0,r._t)("action|ok"))))};var se=o("./src/hooks/useSettings.ts"),ae=o("./src/settings/SettingLevel.ts");const ie=({menuPosition:e,onFinished:t,sender:o,roomId:s,openMenu:a,relation:i})=>{const l=(0,n.useContext)(u.Ay),m=(e=>{const t=[j.Own];return e||t.push(j.Live),t.push(j.Pin),t})(i),p=(0,se.ny)("feature_location_share_live"),h=m.length>1,[_,v]=(0,n.useState)(h?void 0:j.Own),b=X.V.instance.displayName,k=l.getSafeUserId(),y=_===j.Live?((e,t,o,n)=>async({timeout:e})=>{const s=(0,r._t)("location_sharing|live_description",{displayName:o});try{await B.g.instance.createLiveBeacon(t,g.ContentHelpers.makeBeaconInfoContent(null!=e?e:3e5,!0,s,g.LocationAssetType.Self))}catch(e){D(e,n,j.Live)}})(0,s,b||k,a):((e,t,o,n,s)=>async({uri:a,timestamp:i})=>{if(a)try{const s=(null==n?void 0:n.rel_type)===g.THREAD_RELATION_TYPE.name&&(null==n?void 0:n.event_id)||null,r=o===j.Pin?g.LocationAssetType.Pin:g.LocationAssetType.Self,l=g.ContentHelpers.makeLocationContent(void 0,a,i,void 0,r);await(0,F.Y)(t,t=>e.sendMessage(t,s,l),e)}catch(e){D(e,s,o)}})(l,s,null!=_?_:j.Own,i,a),x=_===j.Live&&!p;return n.createElement(c.Ay,(0,d.A)({},e,{onFinished:t,managed:!1}),n.createElement("div",{className:"mx_LocationShareMenu"},x&&n.createElement(ne,{onSubmit:()=>{H.A.setValue("feature_location_share_live",null,ae.p.DEVICE,!0)}}),!x&&!!_&&n.createElement(G,{sender:o,shareType:_,onChoose:y,onFinished:t}),!_&&n.createElement(Q,{setShareType:v,enabledShareTypes:m}),n.createElement(R,{displayBack:!!_&&h,onBack:()=>v(void 0),onCancel:t})))},re=({roomId:e,sender:t,menuPosition:o,relation:s})=>{const d=(0,n.useContext)(m.ZF),[u,p,h,_]=(0,c.EF)(),v=e=>{_(e),null==d||d()};let g=null;if(u){var b;const a=null!==(b=null!=o?o:p.current&&(0,c.qv)(p.current.getBoundingClientRect()))&&void 0!==b?b:{};g=n.createElement(ie,{menuPosition:a,onFinished:v,sender:t,roomId:e,openMenu:h,relation:s})}const k=a()("mx_MessageComposer_button",{mx_MessageComposer_button_highlight:u});return n.createElement(n.Fragment,null,n.createElement(l.J,{className:k,onClick:h,title:(0,r._t)("common|location"),inputRef:p},n.createElement(i.A,null)),g)}},"./src/components/views/location/Marker.tsx":(e,t,o)=>{o.d(t,{A:()=>m});var n=o("./node_modules/react/index.js"),s=o("./node_modules/classnames/index.js"),a=o.n(s),i=o("./node_modules/@vector-im/compound-design-tokens/assets/web/icons/location-pin-solid.js"),r=o("./src/utils/FormattingUtils.ts"),l=o("./src/components/views/avatars/MemberAvatar.tsx");const c=({tooltip:e,children:t})=>{const[o,s]=(0,n.useState)(!1);if(!e)return n.createElement(n.Fragment,null,t);return n.createElement("div",{onMouseEnter:()=>s(!0),onClick:e=>{e.stopPropagation(),s(!o)},onMouseLeave:()=>s(!1)},t,o&&e)},m=({id:e,roomMember:t,useMemberColor:o,tooltip:s,ref:m})=>{const d=o&&t?(0,r.yJ)(t.userId):"";return n.createElement("div",{ref:m,id:e,className:a()("mx_Marker",d,{mx_Marker_defaultColor:!d})},n.createElement(c,{tooltip:s},n.createElement("div",{className:"mx_Marker_border"},t?n.createElement(l.A,{member:t,size:"36px",viewUserOnClick:!1,hideTitle:!!s}):n.createElement(i.A,{className:"mx_Marker_icon"}))))}}}]);
//# sourceMappingURL=7766.js.map