{"version":3,"file":"bundles/b205bf1af9bdedd81a8b/797.js","mappings":"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","sources":["webpack://element-web/./src/async-components/views/dialogs/eventindex/ManageEventIndexDialog.tsx"],"sourcesContent":["/*\nCopyright 2024 New Vector Ltd.\nCopyright 2020, 2021 The Matrix.org Foundation C.I.C.\n\nSPDX-License-Identifier: AGPL-3.0-only OR GPL-3.0-only OR LicenseRef-Element-Commercial\nPlease see LICENSE files in the repository root for full details.\n*/\n\nimport React, { type ChangeEvent } from \"react\";\nimport { type Room } from \"matrix-js-sdk/src/matrix\";\n\nimport { _t } from \"../../../../languageHandler\";\nimport SdkConfig from \"../../../../SdkConfig\";\nimport SettingsStore from \"../../../../settings/SettingsStore\";\nimport Modal from \"../../../../Modal\";\nimport { formatBytes, formatCountLong } from \"../../../../utils/FormattingUtils\";\nimport EventIndexPeg from \"../../../../indexing/EventIndexPeg\";\nimport { SettingLevel } from \"../../../../settings/SettingLevel\";\nimport Field from \"../../../../components/views/elements/Field\";\nimport BaseDialog from \"../../../../components/views/dialogs/BaseDialog\";\nimport DialogButtons from \"../../../../components/views/elements/DialogButtons\";\nimport { type IIndexStats } from \"../../../../indexing/BaseEventIndexManager\";\n\ninterface IProps {\n    onFinished(): void;\n}\n\ninterface IState {\n    /** Size of the event index, in bytes. */\n    eventIndexSize: number;\n\n    /** Number of events currently indexed in the event index. */\n    eventCount: number;\n\n    /** Number of rooms currently mentioned in the event index. */\n    eventIndexRoomCount: number;\n\n    /** Number of rooms awaiting crawling by the EventIndex. */\n    crawlingRoomsCount: number;\n\n    /** Number of encrypted rooms known by the MatrixClient. */\n    roomCount: number;\n\n    /** Room currently being crawled by the EventIndex. */\n    currentRoom: string | null;\n\n    /** Time to sleep between crawlwer passes, in milliseconds. */\n    crawlerSleepTime: number;\n}\n\n/*\n * Allows the user to introspect the event index state and disable it.\n */\nexport default class ManageEventIndexDialog extends React.Component<IProps, IState> {\n    public constructor(props: IProps) {\n        super(props);\n\n        this.state = {\n            eventIndexSize: 0,\n            eventCount: 0,\n            eventIndexRoomCount: 0,\n            crawlingRoomsCount: 0,\n            roomCount: 0,\n            currentRoom: null,\n            crawlerSleepTime: SettingsStore.getValueAt(SettingLevel.DEVICE, \"crawlerSleepTime\"),\n        };\n    }\n\n    public updateCurrentRoom = async (room: Room | null): Promise<void> => {\n        const eventIndex = EventIndexPeg.get();\n        if (!eventIndex) return;\n        let stats: IIndexStats | undefined;\n\n        try {\n            stats = await eventIndex.getStats();\n        } catch {\n            // This call may fail if sporadically, not a huge issue as we will\n            // try later again and probably succeed.\n            return;\n        }\n\n        let currentRoom: string | null = null;\n\n        if (room) currentRoom = room.name;\n        const roomStats = eventIndex.crawlingRooms();\n        const crawlingRoomsCount = roomStats.crawlingRooms.size;\n        const roomCount = roomStats.totalRooms.size;\n\n        this.setState({\n            eventIndexSize: stats?.size ?? 0,\n            eventCount: stats?.eventCount ?? 0,\n            eventIndexRoomCount: stats?.roomCount ?? 0,\n            crawlingRoomsCount: crawlingRoomsCount,\n            roomCount: roomCount,\n            currentRoom: currentRoom,\n        });\n    };\n\n    public componentWillUnmount(): void {\n        const eventIndex = EventIndexPeg.get();\n\n        if (eventIndex !== null) {\n            eventIndex.removeListener(\"changedCheckpoint\", this.updateCurrentRoom);\n        }\n    }\n\n    public async componentDidMount(): Promise<void> {\n        const eventIndex = EventIndexPeg.get();\n\n        if (eventIndex !== null) {\n            eventIndex.on(\"changedCheckpoint\", this.updateCurrentRoom);\n\n            const room = eventIndex.currentRoom();\n            await this.updateCurrentRoom(room);\n        }\n    }\n\n    private onDisable = async (): Promise<void> => {\n        const DisableEventIndexDialog = (await import(\"./DisableEventIndexDialog\")).default;\n        Modal.createDialog(DisableEventIndexDialog, undefined, undefined, /* priority = */ false, /* static = */ true);\n    };\n\n    private onCrawlerSleepTimeChange = (e: ChangeEvent<HTMLInputElement>): void => {\n        this.setState({ crawlerSleepTime: parseInt(e.target.value, 10) });\n        SettingsStore.setValue(\"crawlerSleepTime\", null, SettingLevel.DEVICE, e.target.value);\n    };\n\n    public render(): React.ReactNode {\n        const brand = SdkConfig.get().brand;\n\n        let crawlerState;\n        if (this.state.currentRoom === null) {\n            crawlerState = _t(\"settings|security|message_search_indexing_idle\");\n        } else {\n            crawlerState = _t(\"settings|security|message_search_indexing\", { currentRoom: this.state.currentRoom });\n        }\n\n        const doneRooms = Math.max(0, this.state.eventIndexRoomCount - this.state.crawlingRoomsCount);\n\n        const eventIndexingSettings = (\n            <div>\n                {_t(\"settings|security|message_search_intro\", {\n                    brand,\n                })}\n                <div className=\"mx_SettingsTab_subsectionText\">\n                    {crawlerState}\n                    <br />\n                    {_t(\"settings|security|message_search_space_used\")} {formatBytes(this.state.eventIndexSize, 0)}\n                    <br />\n                    {_t(\"settings|security|message_search_indexed_messages\")} {formatCountLong(this.state.eventCount)}\n                    <br />\n                    {_t(\"settings|security|message_search_indexed_rooms\")}{\" \"}\n                    {_t(\"settings|security|message_search_room_progress\", {\n                        doneRooms: formatCountLong(doneRooms),\n                        totalRooms: formatCountLong(this.state.roomCount),\n                    })}{\" \"}\n                    <br />\n                    {_t(\"settings|security|message_search_pending_rooms\", {\n                        pendingRooms: formatCountLong(this.state.crawlingRoomsCount),\n                    })}\n                    <br />\n                    <Field\n                        label={_t(\"settings|security|message_search_sleep_time\")}\n                        type=\"number\"\n                        value={this.state.crawlerSleepTime.toString()}\n                        onChange={this.onCrawlerSleepTimeChange}\n                    />\n                </div>\n            </div>\n        );\n\n        return (\n            <BaseDialog\n                className=\"mx_ManageEventIndexDialog\"\n                onFinished={this.props.onFinished}\n                title={_t(\"settings|security|message_search_section\")}\n            >\n                {eventIndexingSettings}\n                <DialogButtons\n                    primaryButton={_t(\"action|done\")}\n                    onPrimaryButtonClick={this.props.onFinished}\n                    primaryButtonClass=\"primary\"\n                    cancelButton={_t(\"action|disable\")}\n                    onCancel={this.onDisable}\n                    cancelButtonClass=\"danger\"\n                />\n            </BaseDialog>\n        );\n    }\n}\n"],"names":["ManageEventIndexDialog","React","constructor","props","super","_defineProperty","async","_stats$size","_stats","_stats$eventCount","_stats2","_stats$roomCount","_stats3","eventIndex","EventIndexPeg","get","stats","getStats","currentRoom","room","name","roomStats","crawlingRooms","crawlingRoomsCount","size","roomCount","totalRooms","this","setState","eventIndexSize","eventCount","eventIndexRoomCount","DisableEventIndexDialog","default","Modal","createDialog","undefined","e","crawlerSleepTime","parseInt","target","value","SettingsStore","setValue","SettingLevel","DEVICE","state","getValueAt","componentWillUnmount","removeListener","updateCurrentRoom","componentDidMount","on","render","brand","SdkConfig","crawlerState","_t","doneRooms","Math","max","eventIndexingSettings","className","formatBytes","formatCountLong","pendingRooms","Field","label","type","toString","onChange","onCrawlerSleepTimeChange","BaseDialog","onFinished","title","DialogButtons","primaryButton","onPrimaryButtonClick","primaryButtonClass","cancelButton","onCancel","onDisable","cancelButtonClass"],"sourceRoot":""}