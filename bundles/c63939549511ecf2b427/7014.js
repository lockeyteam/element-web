"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[7014],{"./src/components/views/rooms/wysiwyg_composer/utils/editing.ts":(e,t,n)=>{n.d(t,{r:()=>a,w:()=>i});var s=n("./node_modules/matrix-js-sdk/src/matrix.ts"),r=n("./src/dispatcher/dispatcher.ts"),o=n("./src/dispatcher/actions.ts");function i(e){r.A.dispatch({action:o.r.EditEvent,event:null,timelineRenderingType:e.timelineRenderingType}),r.A.dispatch({action:o.r.FocusSendMessageComposer,context:e.timelineRenderingType})}function a(e,t){const n=t.getEvent().replacingEvent();!n||n.status!==s.EventStatus.QUEUED&&n.status!==s.EventStatus.NOT_SENT||e.cancelPendingEvent(n)}},"./src/components/views/rooms/wysiwyg_composer/utils/message.ts":(e,t,n)=>{n.d(t,{u:()=>j,sendMessage:()=>M});var s=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=n("./node_modules/matrix-js-sdk/src/matrix.ts"),o=n("./src/PosthogAnalytics.ts"),i=n("./src/settings/SettingsStore.ts"),a=n("./src/sendTimePerformanceMetrics.ts"),c=n("./src/utils/local-room.ts"),l=n("./src/effects/index.ts"),m=n("./src/effects/utils.ts"),d=n("./src/dispatcher/dispatcher.ts"),p=n("./src/components/views/dialogs/ConfirmRedactDialog.tsx"),u=n("./src/components/views/rooms/wysiwyg_composer/utils/editing.ts"),g=n("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),y=n("./node_modules/@vector-im/matrix-wysiwyg/dist/matrix-wysiwyg.js"),f=n("./src/utils/permalinks/Permalinks.ts"),_=n("./src/utils/Reply.ts"),h=n("./src/Typeguards.ts");function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,s)}return n}function T(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach(function(t){(0,g.A)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}const E="/me ";const w=e=>e instanceof r.MatrixEvent;async function b(e,t,{relation:n,replyToEvent:s,editedEvent:o}){const a=w(o),c=e.startsWith(E);c&&(e=e.slice(E.length)),e.startsWith("//")&&(e=e.slice(1));const l=t?await(0,y.richToPlain)(e,!1):function(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.querySelectorAll("a[data-mention-type]")).forEach(e=>{switch(e.getAttribute("data-mention-type")){case"at-room":e.replaceWith("@room");break;case"user":{const t=e.innerHTML;e.replaceWith(t);break}case"room":{const t=e.getAttribute("href");if(null===t)break;const n=(0,f.$N)(t);(0,h.P)(n)&&(0,h.P)(n.roomIdOrAlias)&&e.replaceWith(n.roomIdOrAlias);break}}}),t.body.innerHTML}(e),m={msgtype:c?r.MsgType.Emote:r.MsgType.Text,body:a?`* ${l}`:l},d=i.A.getValue("MessageComposerInput.useMarkdown"),p=t?e:d?await(0,y.plainToRich)(e,!0):null;p&&(m.format="org.matrix.custom.html",m.formatted_body=a?`* ${p}`:p),a&&(m["m.new_content"]={msgtype:m.msgtype,body:l},p&&(m["m.new_content"].format="org.matrix.custom.html",m["m.new_content"].formatted_body=p));return function(e,t){t&&(e["m.relates_to"]=T(T({},e["m.relates_to"]||{}),t))}(m,a?T(T({},n),{},{rel_type:"m.replace",event_id:o.getId()}):n),!a&&s&&(0,_.fh)(m,s),m}var A=n("./src/SlashCommands.tsx"),x=n("./src/editor/commands.tsx"),O=n("./src/dispatcher/actions.ts"),P=n("./src/utils/messages.ts");const R=["roomContext","mxClient"];async function M(e,t,n){let{roomContext:p,mxClient:u}=n,g=(0,s.A)(n,R);const{relation:y,replyToEvent:f}=g,{room:h}=p,v=null==h?void 0:h.roomId;if(!v)return;const T={eventName:"Composer",isEditing:!1,messageType:"Text",isReply:Boolean(f),inThread:(null==y?void 0:y.rel_type)===r.THREAD_RELATION_TYPE.name};o.Vo.instance.trackEvent(T);let w=null;if(e.startsWith("/")&&!e.startsWith("//")&&!e.startsWith(E)){const{cmd:t,args:n}=(0,A.OE)(v,e);if(t){const e=(null==y?void 0:y.rel_type)===r.THREAD_RELATION_TYPE.name?null==y?void 0:y.event_id:null;let s;if([w,s]=await(0,x.m8)(u,t,n,v,null!=e?e:null),!s)return;if(!w||t.category!==A.ge.messages&&t.category!==A.ge.effects)return;(0,P.g)(w,y),f&&(0,_.fh)(w,f)}else{const t=await(0,x.d8)(e);if(d.A.dispatch({action:O.r.FocusAComposer,context:p.timelineRenderingType}),!t)return}}if(null!=w||(w=await b(e,t,g)),!w.body.trim())return;i.A.getValue("Performance.addSendMessageTimingMetadata")&&(0,a.H)(w);const M=null!=y&&y.event_id&&(null==y?void 0:y.rel_type)===r.THREAD_RELATION_TYPE.name?y.event_id:null,j=(0,c.Y)(v,e=>u.sendMessage(e,M,w),u);return f&&d.A.dispatch({action:"reply_to_event",event:null,context:p.timelineRenderingType}),d.A.dispatch({action:"message_sent"}),l.y.forEach(e=>{if(w&&(0,m._)(w,e.emojis)){(null==y?void 0:y.rel_type)!==r.THREAD_RELATION_TYPE.name&&d.A.dispatch({action:`effects.${e.command}`})}}),i.A.getValue("Performance.addSendMessageTimingMetadata")&&j.then(e=>{(0,a._)(u,v,e.event_id)}),i.A.getValue("scrollToBottomOnMessageSent")&&d.A.dispatch({action:"scroll_to_bottom",timelineRenderingType:p.timelineRenderingType}),j}async function j(e,{roomContext:t,mxClient:n,editorStateTransfer:s}){const r=s.getEvent();o.Vo.instance.trackEvent({eventName:"Composer",isEditing:!0,messageType:"Text",inThread:Boolean(null==r?void 0:r.getThread()),isReply:Boolean(r.replyEventId)});const i=await b(e,!0,{editedEvent:r}),a=i["m.new_content"];if(""===(null==a?void 0:a.body))return(0,u.r)(n,s),void(0,p.Q)({mxEvent:r,onCloseDialog:()=>{(0,u.w)(t)}});let c;const l=r.getRoomId();if(function(e,t){const n=t.getEvent().getContent();return n.msgtype!==e.msgtype||n.body!==e.body||n.format!==e.format||n.formatted_body!==e.formatted_body}(a,s)&&l){(0,u.r)(n,s);const e=s.getEvent().threadRootId||null;c=n.sendMessage(l,e,i),d.A.dispatch({action:"message_sent"})}return(0,u.w)(t),c}},"./src/sendTimePerformanceMetrics.ts":(e,t,n)=>{function s(e){e["io.element.performance_metrics"]={sendStartTs:Date.now()}}function r(e,t,n){e.sendEvent(t,"io.element.performance_metric",{"io.element.performance_metrics":{forEventId:n,responseTs:Date.now(),kind:"send_time"}})}n.d(t,{H:()=>s,_:()=>r})}}]);
//# sourceMappingURL=7014.js.map